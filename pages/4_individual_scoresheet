import streamlit as st
import pandas as pd
from openpyxl import load_workbook
from docx import Document
import io
import math
from utility.tournament_utils import chinese_to_number

st.set_page_config(page_title="å€‹äººè³½é»å–®è£½ä½œ", layout="wide")
st.title("ğŸ“ å€‹äººè³½é»å–®è‡ªå‹•ç”Ÿæˆ (æ”¯æ´åˆä½µå„²å­˜æ ¼èˆ‡è£åˆ‡æ’åº)")

st.info("""
**ğŸš€ é‹ä½œé‚è¼¯èªªæ˜ï¼š**
1. **æ”¯æ´åˆä½µå„²å­˜æ ¼**ï¼šç³»çµ±æœƒè‡ªå‹•åµæ¸¬ Aã€B æ¬„çš„åˆä½µä½ç½®ï¼Œå‘ä¸Š/ä¸‹æœå°‹æœ€è¿‘çš„æœ‰å€¼å„²å­˜æ ¼ã€‚
2. **å°æŠ˜è£åˆ‡æ’åº**ï¼šè‹¥ç¸½å ´æ¬¡ 99 å ´ï¼ŒWord ç¬¬ 1 é æœƒæ˜¯å ´æ¬¡ 1 èˆ‡ 51ï¼Œæ–¹ä¾¿ä¸€æ¬¡è£åˆ‡ã€‚
3. **è¼¸å…¥éœ€æ±‚**ï¼šExcel D æ¬„ç‚ºåœ‹å­—å ´æ¬¡ã€A æ¬„å­¸æ ¡ã€B æ¬„å§“åï¼›Word ç¯„æœ¬éœ€åŒ…å«å…©å€‹è¡¨æ ¼ã€‚
""")

# --- æª”æ¡ˆä¸Šå‚³ ---
col1, col2 = st.columns(2)
with col1:
    xl_file = st.file_uploader("1. ä¸Šå‚³å·²å¡«å¥½çš„å€‹äººè³½ç±¤è¡¨ (Excel)", type=["xlsx"])
with col2:
    word_template = st.file_uploader("2. ä¸Šå‚³ç©ºç™½é»å–®ç¯„æœ¬ (Word)", type=["docx"])

if xl_file and word_template:
    if st.button("ğŸš€ é–‹å§‹ç”Ÿæˆä¸¦æ’ç‰ˆé»å–®"):
        # --- æ­¥é©Ÿä¸€ï¼šå¾ Excel æŠ“å–å ´æ¬¡èˆ‡å°æ‰‹è³‡è¨Š (è™•ç†åˆä½µå„²å­˜æ ¼) ---
        # ä½¿ç”¨ data_only=True è®€å–å…¬å¼è¨ˆç®—å¾Œçš„çµæœ
        wb = load_workbook(xl_file, data_only=True)
        matches_data = {}

        for ws in wb.worksheets:
            for r in range(1, ws.max_row + 1):
                # è®€å– D æ¬„ (ç¬¬ 4 æ¬„) çš„å ´æ¬¡è™Ÿç¢¼
                cell_val = ws.cell(row=r, column=4).value
                if isinstance(cell_val, str):
                    m_num = chinese_to_number(cell_val)
                    if m_num > 0:
                        # --- å‘ä¸Šæœå°‹æœ€è¿‘çš„é¸æ‰‹ (å·¦å´/ä¸Šæ–¹) ---
                        l_u, l_n = "", ""
                        for search_r in range(r - 1, 0, -1):
                            u = ws.cell(row=search_r, column=1).value
                            n = ws.cell(row=search_r, column=2).value
                            if u or n: # åªè¦å­¸æ ¡æˆ–å§“åå…¶ä¸­ä¸€å€‹æœ‰å€¼å°±æŠ“å–
                                l_u, l_n = str(u or ""), str(n or "")
                                break
                        
                        # --- å‘ä¸‹æœå°‹æœ€è¿‘çš„é¸æ‰‹ (å³å´/ä¸‹æ–¹) ---
                        r_u, r_n = "", ""
                        for search_r in range(r + 1, ws.max_row + 1):
                            u = ws.cell(row=search_r, column=1).value
                            n = ws.cell(row=search_r, column=2).value
                            if u or n:
                                r_u, r_n = str(u or ""), str(n or "")
                                break
                        
                        matches_data[m_num] = {
                            "label": cell_val,
                            "l_u": l_u, "l_n": l_n,
                            "r_u": r_u, "r_n": r_n
                        }

        if not matches_data:
            st.error("âŒ æ‰¾ä¸åˆ°å ´æ¬¡è³‡è¨Šï¼Œè«‹ç¢ºèª Excel D æ¬„æ˜¯å¦æœ‰åœ‹å­—å ´æ¬¡ã€‚")
            st.stop()

        # --- æ­¥é©ŸäºŒï¼šè¨ˆç®—æ’åºé‚è¼¯ (è£åˆ‡æ’åº) ---
        all_nums = sorted(matches_data.keys())
        max_num = all_nums[-1]
        half = math.ceil(max_num / 2) # æ¯é å° 2 å ´ï¼Œæ‰€éœ€ A4 å¼µæ•¸
        
        st.write(f"ğŸ“Š ç¸½å ´æ¬¡ï¼š{max_num}ï¼Œè£åˆ‡åŸºæ•¸ï¼ˆhalfï¼‰ï¼š{half}")

        # --- æ­¥é©Ÿä¸‰ï¼šå¡«å…… Word è¡¨æ ¼ ---
        try:
            # è®€å–ç¯„æœ¬
            template_doc = Document(word_template)
            if len(template_doc.tables) < 2:
                st.error("âŒ Word ç¯„æœ¬æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆåŒ…å«è‡³å°‘å…©å€‹è¡¨æ ¼ï¼ˆä¸ŠåŠå¼µèˆ‡ä¸‹åŠå¼µï¼‰ã€‚")
                st.stop()
            
            output_doc = Document()

            for i in range(1, half + 1):
                # å–å¾—é…å°å ´æ¬¡ï¼ši æ˜¯ä¸ŠåŠå¼µ, i + half æ˜¯ä¸‹åŠå¼µ
                top_id = i
                bot_id = i + half if (i + half) <= max_num else None
                
                # 1. è™•ç†ä¸ŠåŠå¼µ (Table 0)
                if top_id in matches_data:
                    data = matches_data[top_id]
                    # å¾ç¯„æœ¬è¤‡è£½è¡¨æ ¼çµæ§‹èˆ‡æ¨£å¼
                    # (è¨»ï¼šé€™æ˜¯ä¸€å€‹ç°¡åŒ–ç‰ˆçš„è¡¨æ ¼ç”Ÿæˆï¼Œåº§æ¨™ç´¢å¼•éœ€æ ¹æ“šæ‚¨çš„ç¯„æœ¬èª¿æ•´)
                    table_top = output_doc.add_table(rows=len(template_doc.tables[0].rows), 
                                                   cols=len(template_doc.tables[0].columns))
                    table_top.style = template_doc.tables[0].style
                    
                    # âš ï¸ é€™è£¡çš„ (row, col) åº§æ¨™è«‹æ ¹æ“šæ‚¨çš„ Word è¡¨æ ¼å¯¦éš›ä½ç½®ä¿®æ”¹
                    table_top.cell(0, 0).text = f"å ´æ¬¡ï¼š{data['label']}"
                    table_top.cell(1, 1).text = data['l_u'] # å·¦å´å­¸æ ¡
                    table_top.cell(2, 1).text = data['l_n'] # å·¦å´å§“å
                    table_top.cell(1, 3).text = data['r_u'] # å³å´å­¸æ ¡
                    table_top.cell(2, 3).text = data['r_n'] # å³å´å§“å

                output_doc.add_paragraph("\n") # è¡¨æ ¼ä¸­é–“ç•™é»ç©ºéš™

                # 2. è™•ç†ä¸‹åŠå¼µ (Table 1)
                if bot_id and bot_id in matches_data:
                    data = matches_data[bot_id]
                    table_bot = output_doc.add_table(rows=len(template_doc.tables[1].rows), 
                                                   cols=len(template_doc.tables[1].columns))
                    table_bot.style = template_doc.tables[1].style
                    
                    table_bot.cell(0, 0).text = f"å ´æ¬¡ï¼š{data['label']}"
                    table_bot.cell(1, 1).text = data['l_u'] 
                    table_bot.cell(2, 1).text = data['l_n'] 
                    table_bot.cell(1, 3).text = data['r_u'] 
                    table_bot.cell(2, 3).text = data['r_n'] 

                # å¦‚æœä¸æ˜¯æœ€å¾Œä¸€é ï¼Œæ’å…¥åˆ†é ç¬¦è™Ÿ
                if i < half:
                    output_doc.add_page_break()

            # --- æ­¥é©Ÿå››ï¼šæä¾›ä¸‹è¼‰ ---
            target_stream = io.BytesIO()
            output_doc.save(target_stream)
            st.success(f"ğŸ‰ é»å–®ç”Ÿæˆå®Œç•¢ï¼å…±è¨ˆ {max_num} å ´ï¼Œ{half} é  Wordã€‚")
            st.download_button(
                label="ğŸ’¾ ä¸‹è¼‰æ¯”è³½é»å–® Word",
                data=target_stream.getvalue(),
                file_name="å€‹äººè³½é»å–®_è£åˆ‡æ’ç‰ˆ.docx",
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            )

        except Exception as e:
            st.error(f"ç™¼ç”Ÿæœªé æœŸéŒ¯èª¤ï¼š{e}")

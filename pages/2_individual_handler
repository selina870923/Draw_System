import streamlit as st
import pandas as pd
from openpyxl import load_workbook
import io

st.set_page_config(page_title="å€‹äººè³½ç±¤è¡¨è£½ä½œ", layout="wide")
st.title("ğŸ‘¤ å€‹äººè³½ç±¤è¡¨ç”Ÿæˆå™¨")

st.info("""
**ğŸ“‹ ä½¿ç”¨æµç¨‹ï¼š**
1. ä¸Šå‚³åŒ…å«å¤šå€‹é …ç›®åå–®çš„**æŠ½ç±¤çµæœ**ã€‚
2. å¾ä¸‹æ–¹é¸å–®**é¸æ“‡ä¸€å€‹é …ç›®**ï¼ˆåˆ†é ï¼‰ä½œç‚ºæœ¬æ¬¡å¡«è¡¨ä¾†æºã€‚
3. ä¸Šå‚³**ç©ºç™½ç±¤è¡¨**ï¼ˆç³»çµ±æœƒè‡ªå‹•æƒææ‰€æœ‰åˆ†é ä¸¦å¡«å…¥è³‡æ–™ï¼‰ã€‚
""")

# --- æª”æ¡ˆä¸Šå‚³ ---
col1, col2 = st.columns(2)
with col1:
    draw_file = st.file_uploader("1. ä¸Šå‚³æŠ½ç±¤çµæœ (Excel)", type=["xlsx"])
with col2:
    template_file = st.file_uploader("2. ä¸Šå‚³ç©ºç™½ç±¤è¡¨ç¯„æœ¬ (Excel)", type=["xlsx"])

if draw_file and template_file:
    # è®€å–æŠ½ç±¤æª”æ¡ˆçš„æ‰€æœ‰åˆ†é åç¨±ï¼Œè®“ä½¿ç”¨è€…é¸æ“‡ã€Œä¸€å€‹ã€ä¾†æº
    draw_xl = pd.ExcelFile(draw_file)
    sheet_names = draw_xl.sheet_names
    
    st.subheader("ğŸ¯ é …ç›®é¸æ“‡")
    # æ”¹ç”¨ radio æˆ– selectboxï¼Œç¢ºä¿ä½¿ç”¨è€…åªé¸ä¸€å€‹é …ç›®
    selected_item_sheet = st.selectbox(
        "è«‹é¸æ“‡æœ¬æ¬¡è¦è£½ä½œçš„é …ç›®åå–®ï¼ˆåˆ†é ï¼‰ï¼š",
        options=sheet_names,
        index=0
    )

    # è®€å–è©²é¸å®šåˆ†é çš„è³‡æ–™
    try:
        draw_df = pd.read_excel(draw_file, sheet_name=selected_item_sheet)
        
        # æª¢æŸ¥å¿…è¦æ¬„ä½
        required_cols = {'æŠ½ç±¤çµæœ', 'å–®ä½', 'åç¨±'}
        if not required_cols.issubset(draw_df.columns):
            st.error(f"âŒ é¸å–çš„åˆ†é ã€{selected_item_sheet}ã€æ¬„ä½ä¸æ­£ç¢ºï¼Œå¿…é ˆåŒ…å«: {required_cols}")
            st.stop()

        # å»ºç«‹åå–® Map
        data_map = {
            int(row['æŠ½ç±¤çµæœ']): {'unit': str(row['å–®ä½']), 'name': str(row['åç¨±'])} 
            for _, row in draw_df.dropna(subset=['æŠ½ç±¤çµæœ']).iterrows()
        }
        draw_indices = set(data_map.keys())
    except Exception as e:
        st.error(f"è®€å–åå–®æ™‚å‡ºéŒ¯ï¼š{e}")
        st.stop()

    if st.button(f"ğŸš€ é–‹å§‹å¡«å…¥ã€{selected_item_sheet}ã€‘è³‡æ–™"):
        wb = load_workbook(template_file)
        template_indices = set()
        
        # ç¬¬ä¸€éæƒæï¼šç¢ºèªæ‰€æœ‰åˆ†é ä¸­ C æ¬„å‡ºç¾çš„åºè™Ÿ
        for ws in wb.worksheets:
            for row_idx in range(1, ws.max_row + 1):
                val = ws.cell(row=row_idx, column=3).value
                try:
                    if val is not None:
                        # è™•ç† Excel å…§å¯èƒ½å‡ºç¾çš„æµ®é»æ•¸åºè™Ÿ
                        idx = int(float(str(val).strip()))
                        template_indices.add(idx)
                except:
                    continue

        # å»åˆåº¦æª¢æŸ¥
        if draw_indices != template_indices:
            missing = draw_indices - template_indices
            extra = template_indices - draw_indices
            
            st.error(f"âŒ åå–®èˆ‡ç±¤è¡¨åºè™Ÿä¸å»åˆï¼")
            if missing:
                st.write(f"âš ï¸ åå–®ä¸­æœ‰ã€ä½†ç±¤è¡¨æ‰¾ä¸åˆ°çš„ä½ç½®ï¼š{sorted(list(missing))}")
            if extra:
                st.write(f"âš ï¸ ç±¤è¡¨æœ‰ä½ç½®ã€ä½†åå–®ä¸­æ²’äººï¼ˆå«æœªå®šç¾©çš„ Byeï¼‰ï¼š{sorted(list(extra))}")
            
            st.warning("è«‹æª¢æŸ¥æ‚¨é¸æ“‡çš„åå–®åˆ†é èˆ‡ä¸Šå‚³çš„ç¯„æœ¬æ˜¯å¦åŒ¹é…ã€‚")
        else:
            # ç¬¬äºŒéæƒæï¼šæ­£å¼å¡«å…¥
            fill_count = 0
            for ws in wb.worksheets:
                for row_idx in range(1, ws.max_row + 1):
                    val = ws.cell(row=row_idx, column=3).value
                    try:
                        if val is not None:
                            idx = int(float(str(val).strip()))
                            if idx in data_map:
                                # Aæ¬„å¡«å–®ä½ï¼ŒBæ¬„å¡«åç¨±
                                ws.cell(row=row_idx, column=1).value = data_map[idx]['unit']
                                ws.cell(row=row_idx, column=2).value = data_map[idx]['name']
                                fill_count += 1
                    except:
                        continue
            
            # ä¸‹è¼‰è™•ç†
            output = io.BytesIO()
            wb.save(output)
            st.success(f"âœ… ã€{selected_item_sheet}ã€‘è™•ç†å®Œæˆï¼å…±å¡«å…¥ {fill_count} ç­†è³‡æ–™ã€‚")
            st.download_button(
                label=f"ğŸ’¾ ä¸‹è¼‰ {selected_item_sheet} ç±¤è¡¨çµæœ",
                data=output.getvalue(),
                file_name=f"{selected_item_sheet}_ç±¤è¡¨çµæœ.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )

import streamlit as st
import pandas as pd
from openpyxl import load_workbook
import io
import re
from utility.tournament_utils import to_chinese_match_no

# ==========================================
# 1. åœ˜é«”è³½å°ˆç”¨ï¼šå¾ªç’°è³½å°é™£æ¼”ç®—æ³•
# ==========================================
def get_round_robin_matches(n):
    teams = list(range(1, n + 1))
    if n % 2 != 0:
        teams.append(None)
    
    count = len(teams)
    all_rounds = []
    for _ in range(count - 1):
        round_matches = []
        for i in range(count // 2):
            t1, t2 = teams[i], teams[count - 1 - i]
            if t1 is not None and t2 is not None:
                round_matches.append(tuple(sorted((t1, t2))))
        all_rounds.append(round_matches)
        teams = [teams[0]] + [teams[-1]] + teams[1:-1]
    return all_rounds

# ==========================================
# 2. ä»‹é¢èˆ‡è™•ç†ç¨‹å¼
# ==========================================
st.set_page_config(page_title="åœ˜é«”è³½ç±¤è¡¨è£½ä½œ", layout="wide")
st.title("ğŸ† åœ˜é«”è³½å¾ªç’°è³½ç±¤è¡¨ç”Ÿæˆå™¨")

col1, col2 = st.columns(2)
with col1:
    draw_file = st.file_uploader("1. ä¸Šå‚³æŠ½ç±¤çµæœ (Excel)", type=["xlsx"])
with col2:
    template_file = st.file_uploader("2. ä¸Šå‚³ç©ºç™½ç±¤è¡¨ç¯„æœ¬ (Excel)", type=["xlsx"])

if draw_file and template_file:
    # è®€å–æŠ½ç±¤æª”æ¡ˆçš„æ‰€æœ‰åˆ†é åç¨±
    draw_xl = pd.ExcelFile(draw_file)
    sheet_names = draw_xl.sheet_names
    
    st.subheader("ğŸ¯ é …ç›®é¸æ“‡")
    # èˆ‡å€‹äººè³½ä¸€è‡´çš„ Selectbox
    selected_item_sheet = st.selectbox(
        "è«‹é¸æ“‡æœ¬æ¬¡è¦è£½ä½œçš„åœ˜é«”é …ç›®åå–®ï¼ˆåˆ†é ï¼‰ï¼š",
        options=sheet_names,
        index=0
    )

    # è®€å–é¸å®šåˆ†é è³‡æ–™
    try:
        draw_df = pd.read_excel(draw_file, sheet_name=selected_item_sheet)
        # å»ºç«‹éšŠä¼æŸ¥è©¢å­—å…¸
        data_map = {
            int(row['æŠ½ç±¤çµæœ']): str(row['å–®ä½']) 
            for _, row in draw_df.dropna(subset=['æŠ½ç±¤çµæœ']).iterrows()
        }
        draw_indices = set(data_map.keys())
    except Exception as e:
        st.error(f"è®€å–åå–®æ™‚å‡ºéŒ¯ï¼Œè«‹ç¢ºä¿åŒ…å« 'æŠ½ç±¤çµæœ' èˆ‡ 'å–®ä½' æ¬„ä½ã€‚")
        st.stop()

    if st.button(f"ğŸš€ é–‹å§‹å¡«å…¥ã€{selected_item_sheet}ã€‘åœ˜é«”è³½ç¨‹"):
        wb = load_workbook(template_file)
        all_group_info = {}
        template_indices = set()
        
        # æ­¥é©Ÿä¸€ï¼šè§£æç¯„æœ¬ A æ¬„çµæ§‹ä¸¦æ”¶é›†åºè™Ÿ
        for ws in wb.worksheets:
            current_group = None
            for row_idx in range(1, ws.max_row + 1):
                val = ws.cell(row=row_idx, column=1).value
                if val is None: continue
                
                # è¾¨è­˜çµ„åˆ¥ (A, B, C...)
                if isinstance(val, str) and re.match(r'^[A-Za-z]$', val.strip()):
                    current_group = val.strip().upper()
                    all_group_info[(ws.title, current_group)] = {"teams": [], "rounds": []}
                # è¾¨è­˜éšŠä¼åºè™Ÿ
                elif isinstance(val, (int, float)) and current_group:
                    tid = int(val)
                    all_group_info[(ws.title, current_group)]["teams"].append((row_idx, tid))
                    template_indices.add(tid)

        # æ­¥é©ŸäºŒï¼šè³‡æ–™å»åˆåº¦æª¢æŸ¥
        if draw_indices != template_indices:
            missing = draw_indices - template_indices
            extra = template_indices - draw_indices
            st.error("âŒ åå–®èˆ‡ç¯„æœ¬åºè™Ÿä¸å»åˆï¼")
            if missing: st.write(f"âš ï¸ åå–®å¤šå‡ºçš„åºè™Ÿï¼š{sorted(list(missing))}")
            if extra: st.write(f"âš ï¸ ç¯„æœ¬å¤šå‡ºçš„åºè™Ÿï¼š{sorted(list(extra))}")
        else:
            # æ­¥é©Ÿä¸‰ï¼šç”Ÿæˆå ´æ¬¡èˆ‡å¡«è¡¨é‚è¼¯
            match_labels = {}
            counter = 1
            
            # è¨ˆç®—å„çµ„è¼ªæ¬¡
            for key in all_group_info:
                n = len(all_group_info[key]["teams"])
                all_group_info[key]["rounds"] = get_round_robin_matches(n)
            
            max_r = max((len(info["rounds"]) for info in all_group_info.values()), default=0)
            
            # äº¤å‰ç·¨è™Ÿ (A1->B1->A2->B2...)
            for r_idx in range(max_r):
                for key in sorted(all_group_info.keys()):
                    rounds = all_group_info[key]["rounds"]
                    if r_idx < len(rounds):
                        for m in rounds[r_idx]:
                            label = to_chinese_match_no(counter) if counter <= 99 else "è¶…é"
                            t1_val = all_group_info[key]["teams"][m[0]-1][1]
                            t2_val = all_group_info[key]["teams"][m[1]-1][1]
                            match_labels[(key[0], key[1], t1_val, t2_val)] = label
                            counter += 1

            # æ­¥é©Ÿå››ï¼šæ­£å¼å¯«å…¥ Excel
            for (sheet_name, group_name), info in all_group_info.items():
                ws = wb[sheet_name]
                team_list = info["teams"]
                for i, (r_idx, tid) in enumerate(team_list):
                    team_name = data_map.get(tid, f"æœªçŸ¥({tid})")
                    ws.cell(row=r_idx, column=1).value = team_name # ç¸±è»¸
                    header_row = team_list[0][0] - 1
                    if header_row > 0:
                        ws.cell(row=header_row, column=i+2).value = team_name # æ©«è»¸
                    
                    for j, (r_idx_j, tid_j) in enumerate(team_list):
                        if i == j: continue
                        pair = tuple(sorted((tid, tid_j)))
                        label = match_labels.get((sheet_name, group_name, pair[0], pair[1]))
                        if label:
                            ws.cell(row=r_idx, column=j+2).value = label

            output = io.BytesIO()
            wb.save(output)
            st.success(f"âœ… ã€{selected_item_sheet}ã€‘è™•ç†å®Œæˆï¼å…±è¨ˆ {counter-1} å€‹å ´æ¬¡ã€‚")
            st.download_button(f"ğŸ’¾ ä¸‹è¼‰åœ˜é«”è³½ç¨‹çµæœ", output.getvalue(), f"{selected_item_sheet}_åœ˜é«”è³½ç¨‹.xlsx")

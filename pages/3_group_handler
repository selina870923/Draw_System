import streamlit as st
import pandas as pd
from openpyxl import load_workbook
import io
import re
# å¾ utility å¼•å…¥å…±ç”¨çš„åœ‹å­—è½‰æ›
from utility.tournament_utils import to_chinese_match_no

# ==========================================
# 1. åœ˜é«”è³½å°ˆç”¨ï¼šå¾ªç’°è³½å°é™£æ¼”ç®—æ³• (ç§»å›æ­¤è™•)
# ==========================================
def get_round_robin_matches(n):
    """
    ç”Ÿæˆå–®å¾ªç’°å°é™£è¡¨ (åœ“ç’°æ³•æ¼”ç®—æ³•)
    """
    teams = list(range(1, n + 1))
    if n % 2 != 0:
        teams.append(None) # å¥‡æ•¸éšŠä¼è£œ Bye
    
    count = len(teams)
    all_rounds = []
    for _ in range(count - 1):
        round_matches = []
        for i in range(count // 2):
            t1, t2 = teams[i], teams[count - 1 - i]
            if t1 is not None and t2 is not None:
                round_matches.append(tuple(sorted((t1, t2))))
        all_rounds.append(round_matches)
        # å›ºå®šç¬¬ä¸€ä½ï¼Œå…¶é¤˜é †æ™‚é‡æ—‹è½‰
        teams = [teams[0]] + [teams[-1]] + teams[1:-1]
    return all_rounds

# ==========================================
# 2. ä»‹é¢èˆ‡è™•ç†ç¨‹å¼
# ==========================================
st.set_page_config(page_title="åœ˜é«”è³½ç±¤è¡¨è£½ä½œ", layout="wide")
st.title("ğŸ† åœ˜é«”è³½å¾ªç’°è³½ç±¤è¡¨ç”Ÿæˆå™¨")

st.info("è«‹ä¸Šå‚³æŠ½ç±¤çµæœ Excel èˆ‡ç©ºç™½å¾ªç’°è³½ç¯„æœ¬ã€‚ç³»çµ±å°‡è‡ªå‹•è¾¨è­˜ A æ¬„çš„çµ„åˆ¥èˆ‡åºè™Ÿä¸¦å¡«å…¥å ´æ¬¡ã€‚")

draw_file = st.file_uploader("1. ä¸Šå‚³æŠ½ç±¤çµæœ (Excel)", type=["xlsx"])
template_file = st.file_uploader("2. ä¸Šå‚³ç©ºç™½ç±¤è¡¨ç¯„æœ¬ (Excel)", type=["xlsx"])

if draw_file and template_file:
    draw_df = pd.read_excel(draw_file)
    try:
        # å»ºç«‹éšŠä¼æŸ¥è©¢å­—å…¸
        data_map = {int(row['æŠ½ç±¤çµæœ']): str(row['å–®ä½']) for _, row in draw_df.iterrows()}
    except Exception as e:
        st.error("æŠ½ç±¤çµæœæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿åŒ…å« 'æŠ½ç±¤çµæœ' èˆ‡ 'å–®ä½' æ¬„ä½ã€‚")
        st.stop()

    if st.button("åŸ·è¡Œè‡ªå‹•å¡«è¡¨"):
        wb = load_workbook(template_file)
        all_group_info = {}
        
        # æ­¥é©Ÿä¸€ï¼šè§£æç¯„æœ¬ A æ¬„çµæ§‹ (è¾¨è­˜ A, B, C èˆ‡éšŠä¼åºè™Ÿ)
        for ws in wb.worksheets:
            current_group = None
            for row_idx in range(1, ws.max_row + 1):
                val = ws.cell(row=row_idx, column=1).value
                if val is None: continue
                
                if isinstance(val, str) and re.match(r'^[A-Za-z]$', val.strip()):
                    current_group = val.strip().upper()
                    all_group_info[(ws.title, current_group)] = {"teams": [], "rounds": []}
                elif isinstance(val, (int, float)) and current_group:
                    all_group_info[(ws.title, current_group)]["teams"].append((row_idx, int(val)))

        # æ­¥é©ŸäºŒï¼šç”Ÿæˆå°é™£ä¸¦äº¤å‰ç·¨è™Ÿ (A1 -> B1 -> C1 -> A2...)
        match_labels = {}
        counter = 1
        
        for key in all_group_info:
            n = len(all_group_info[key]["teams"])
            all_group_info[key]["rounds"] = get_round_robin_matches(n)
        
        max_r = max((len(info["rounds"]) for info in all_group_info.values()), default=0)
        
        for r_idx in range(max_r):
            for key in sorted(all_group_info.keys()):
                rounds = all_group_info[key]["rounds"]
                if r_idx < len(rounds):
                    for m in rounds[r_idx]:
                        if counter > 99:
                            label = "ä¸æ”¯æ´"
                        else:
                            label = to_chinese_match_no(counter)
                        
                        # æ‰¾åˆ° A æ¬„å°æ‡‰çš„åŸå§‹éšŠä¼ç·¨è™Ÿ
                        t1_val = all_group_info[key]["teams"][m[0]-1][1]
                        t2_val = all_group_info[key]["teams"][m[1]-1][1]
                        match_labels[(key[0], key[1], t1_val, t2_val)] = label
                        counter += 1

        # æ­¥é©Ÿä¸‰ï¼šå¡«å…¥éšŠä¼åèˆ‡å ´æ¬¡ç·¨è™Ÿ
        for (sheet_name, group_name), info in all_group_info.items():
            ws = wb[sheet_name]
            team_list = info["teams"]
            
            for i, (r_idx, tid) in enumerate(team_list):
                team_name = data_map.get(tid, f"æœªçŸ¥åå–®({tid})")
                ws.cell(row=r_idx, column=1).value = team_name # ç¸±è»¸
                
                header_row = team_list[0][0] - 1 # æ©«è»¸å¡«åœ¨è©²çµ„ç¬¬ä¸€åˆ—çš„ä¸Šæ–¹
                if header_row > 0:
                    ws.cell(row=header_row, column=i+2).value = team_name
                
                for j, (r_idx_j, tid_j) in enumerate(team_list):
                    if i == j: continue
                    pair = tuple(sorted((tid, tid_j)))
                    label = match_labels.get((sheet_name, group_name, pair[0], pair[1]))
                    if label:
                        ws.cell(row=r_idx, column=j+2).value = label

        output = io.BytesIO()
        wb.save(output)
        st.success(f"âœ… ç”Ÿæˆå®Œç•¢ï¼å…±è¨ˆ {counter-1} å€‹å ´æ¬¡ã€‚")
        st.download_button(
            label="ğŸ’¾ ä¸‹è¼‰åœ˜é«”è³½ç±¤è¡¨",
            data=output.getvalue(),
            file_name="åœ˜é«”è³½ç¨‹çµæœ.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
